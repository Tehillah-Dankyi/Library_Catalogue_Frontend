<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Library Catalogue</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div id="navbar"></div>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1>Admin Panel - Book Management</h1>
            <button class="btn" id="addNewBookBtn">Add New Book</button>
        </div>
        <div id="message" style="display: none;"></div>
        <div id="loading" class="loading">Loading books...</div>
        <div id="booksTable"></div>
    </div>

    <!-- Add Book Modal -->
    <div id="addModal" class="modal-overlay" style="display: none">
        <div class="modal" onclick="event.stopPropagation()">
            <h2>Add New Book</h2>
            <form id="addForm">
                <div class="form-group">
                    <label>Title * <span style="font-size: 12px; color: #666;">(max 255 characters)</span></label>
                    <input type="text" id="addTitle" maxlength="255" required>
                    <span id="addTitleCount" style="font-size: 12px; color: #666;"></span>
                </div>
                <div class="form-group">
                    <label>Author * <span style="font-size: 12px; color: #666;">(max 255 characters)</span></label>
                    <input type="text" id="addAuthor" maxlength="255" required>
                    <span id="addAuthorCount" style="font-size: 12px; color: #666;"></span>
                </div>
                <div class="form-group">
                    <label>ISBN * <span style="font-size: 12px; color: #666;">(max 50 characters, must be unique)</span></label>
                    <input type="text" id="addIsbn" maxlength="50" required>
                    <span id="addIsbnCount" style="font-size: 12px; color: #666;"></span>
                </div>
                <div class="form-group">
                    <label>Category <span style="font-size: 12px; color: #666;">(max 100 characters, optional)</span></label>
                    <input type="text" id="addCategory" maxlength="100">
                    <span id="addCategoryCount" style="font-size: 12px; color: #666;"></span>
                </div>
                <div id="addFormError" class="error-message" style="display: none; margin-bottom: 15px;"></div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideAddModal()">Cancel</button>
                    <button type="submit" class="btn" id="addSubmitBtn">Add Book</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Edit Book Modal -->
    <div id="editModal" class="modal-overlay" style="display: none;">
        <div class="modal" onclick="event.stopPropagation()">
            <h2>Edit Book</h2>
            <form id="editForm">
                <div class="form-group">
                    <label>Title *</label>
                    <input type="text" id="editTitle" required>
                </div>
                <div class="form-group">
                    <label>Author *</label>
                    <input type="text" id="editAuthor" required>
                </div>
                <div class="form-group">
                    <label>ISBN *</label>
                    <input type="text" id="editIsbn" required>
                </div>
                <div class="form-group">
                    <label>Category</label>
                    <input type="text" id="editCategory">
                </div>
                <div class="form-group">
                    <label>Status</label>
                    <select id="editStatus">
                        <option value="available">Available</option>
                        <option value="borrowed">Borrowed</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="hideEditModal()">Cancel</button>
                    <button type="submit" class="btn">Update Book</button>
                </div>
            </form>
        </div>
    </div>

    <script src="js/auth.js"></script>
    <script src="js/api.js"></script>
    <script src="js/navbar.js"></script>
    <script>
        // Check admin authentication
        if (!checkAuth() || !checkAdmin()) window.location.href = 'login.html';

        let books = [];
        let selectedBook = null;
        const addNewBookBtn = document.getElementById('addNewBookBtn');
        addNewBookBtn.addEventListener('click', showAddModal);

        async function fetchBooks() {
            try {
                document.getElementById('loading').style.display = 'block';
                const response = await api.get('/books');
                books = response.data.books;
                renderBooks();
            } catch (error) {
                console.error('Error fetching books:', error);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function renderBooks() {
            const container = document.getElementById('booksTable');
            container.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Author</th>
                                <th>ISBN</th>
                                <th>Category</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${books.map(book => `
                                <tr>
                                    <td>${book.title}</td>
                                    <td>${book.author}</td>
                                    <td>${book.isbn}</td>
                                    <td>${book.category || 'N/A'}</td>
                                    <td><span class="status-badge status-${book.availability_status}">${book.availability_status}</span></td>
                                    <td>
                                        <button class="btn btn-secondary" onclick="showEditModal(${book.id})" style="margin-right: 10px; padding: 6px 12px; font-size: 14px;">Edit</button>
                                        <button class="btn btn-danger" onclick="handleDelete(${book.id})" style="padding: 6px 12px; font-size: 14px;">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function showAddModal() {
            document.getElementById('addModal').style.display = 'block';
            document.getElementById('addForm').reset();
            document.getElementById('addFormError').style.display = 'none';
            // updateCharCounts();
            document.getElementById('addTitleCount').textContent = '0/255';
            document.getElementById('addAuthorCount').textContent = '0/255';
            document.getElementById('addIsbnCount').textContent = '0/50';
            document.getElementById('addCategoryCount').textContent = '0/100';
        }

        // function updateCharCounts() {
        //     // Title count
        //     const titleInput = document.getElementById('addTitle');
        //     const titleCount = document.getElementById('addTitleCount');
        //     titleInput.addEventListener('input', () => {
        //         titleCount.textContent = `${titleInput.value.length}/255`;
        //     });

        //     // Author count
        //     const authorInput = document.getElementById('addAuthor');
        //     const authorCount = document.getElementById('addAuthorCount');
        //     authorInput.addEventListener('input', () => {
        //         authorCount.textContent = `${authorInput.value.length}/255`;
        //     });

        //     // ISBN count
        //     const isbnInput = document.getElementById('addIsbn');
        //     const isbnCount = document.getElementById('addIsbnCount');
        //     isbnInput.addEventListener('input', () => {
        //         isbnCount.textContent = `${isbnInput.value.length}/50`;
        //     });

        //     // Category count
        //     const categoryInput = document.getElementById('addCategory');
        //     const categoryCount = document.getElementById('addCategoryCount');
        //     categoryInput.addEventListener('input', () => {
        //         categoryCount.textContent = `${categoryInput.value.length}/100`;
        //     });
        // }

        function hideAddModal() {
            document.getElementById('addModal').style.display = 'none';
        }

        function showEditModal(bookId) {
            selectedBook = books.find(b => b.id === bookId);
            if (!selectedBook) return;
            
            document.getElementById('editTitle').value = selectedBook.title;
            document.getElementById('editAuthor').value = selectedBook.author;
            document.getElementById('editIsbn').value = selectedBook.isbn;
            document.getElementById('editCategory').value = selectedBook.category || '';
            document.getElementById('editStatus').value = selectedBook.availability_status;
            
            document.getElementById('editModal').style.display = 'flex';
        }

        function hideEditModal() {
            document.getElementById('editModal').style.display = 'none';
            selectedBook = null;
        }

        async function handleAdd(e) {
            e.preventDefault();
            const errorDiv = document.getElementById('addFormError');
            const submitBtn = document.getElementById('addSubmitBtn');
            
            // Get form values
            const title = document.getElementById('addTitle').value.trim();
            const author = document.getElementById('addAuthor').value.trim();
            const isbn = document.getElementById('addIsbn').value.trim();
            const category = document.getElementById('addCategory').value.trim();

            // Validation
            if (!title || !author || !isbn) {
                errorDiv.textContent = 'Title, Author, and ISBN are required fields.';
                errorDiv.style.display = 'block';
                return;
            }

            if (title.length > 255) {
                errorDiv.textContent = 'Title must be 255 characters or less.';
                errorDiv.style.display = 'block';
                return;
            }

            if (author.length > 255) {
                errorDiv.textContent = 'Author must be 255 characters or less.';
                errorDiv.style.display = 'block';
                return;
            }

            if (isbn.length > 50) {
                errorDiv.textContent = 'ISBN must be 50 characters or less.';
                errorDiv.style.display = 'block';
                return;
            }

            if (category.length > 100) {
                errorDiv.textContent = 'Category must be 100 characters or less.';
                errorDiv.style.display = 'block';
                return;
            }

            // Prepare form data matching database schema
            const formData = {
                title: title,
                author: author,
                isbn: isbn,
                category: category || null  // Send null if empty (matches database schema)
            };

            errorDiv.style.display = 'none';
            submitBtn.disabled = true;
            submitBtn.textContent = 'Adding...';

            try {
                const response = await api.post('/books', formData);
                showMessage('Book added successfully!', 'success');
                hideAddModal();
                fetchBooks();
            } catch (error) {
                const errorMsg = error.response?.data?.error || 'Failed to add book. Please try again.';
                errorDiv.textContent = errorMsg;
                errorDiv.style.display = 'block';
                showMessage(errorMsg, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Add Book';
            }
        }

        async function handleEdit(e) {
            e.preventDefault();
            const formData = {
                title: document.getElementById('editTitle').value,
                author: document.getElementById('editAuthor').value,
                isbn: document.getElementById('editIsbn').value,
                category: document.getElementById('editCategory').value,
                availability_status: document.getElementById('editStatus').value
            };

            try {
                await api.put(`/books/${selectedBook.id}`, formData);
                showMessage('Book updated successfully!', 'success');
                hideEditModal();
                fetchBooks();
            } catch (error) {
                showMessage(error.response?.data?.error || 'Failed to update book', 'error');
            }
        }

        async function handleDelete(bookId) {
            if (!confirm('Are you sure you want to delete this book?')) return;

            try {
                await api.delete(`/books/${bookId}`);
                showMessage('Book deleted successfully!', 'success');
                fetchBooks();
            } catch (error) {
                showMessage(error.response?.data?.error || 'Failed to delete book', 'error');
            }
        }

        function showMessage(text, type) {
            const messageDiv = document.getElementById('message');
            messageDiv.textContent = text;
            messageDiv.className = type === 'success' ? 'success-message' : 'error-message';
            messageDiv.style.display = 'block';
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 3000);
        }

        // Event listeners
        document.getElementById('addForm').addEventListener('submit', handleAdd);
        document.getElementById('editForm').addEventListener('submit', handleEdit);
        document.getElementById('addModal').addEventListener('click', (e) => {
            if (e.target.id === 'addModal') hideAddModal();
        });
        document.getElementById('editModal').addEventListener('click', (e) => {
            if (e.target.id === 'editModal') hideEditModal();
        });

        // Character count updates
        document.getElementById('addTitle').addEventListener('input', () => {
            const count = document.getElementById('addTitle').value.length;
            document.getElementById('addTitleCount').textContent = `${count}/255`;
        });
        document.getElementById('addAuthor').addEventListener('input', () => {
            const count = document.getElementById('addAuthor').value.length;
            document.getElementById('addAuthorCount').textContent = `${count}/255`;
        });
        document.getElementById('addIsbn').addEventListener('input', () => {
            const count = document.getElementById('addIsbn').value.length;
            document.getElementById('addIsbnCount').textContent = `${count}/50`;
        });
        document.getElementById('addCategory').addEventListener('input', () => {
            const count = document.getElementById('addCategory').value.length;
            document.getElementById('addCategoryCount').textContent = `${count}/100`;
        });

        // Initial load
        fetchBooks();
    </script>
</body>
</html>


